{% extends 'employee/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Form Builder{% endblock %}

{% block extra_head %}
{% comment %} Import sortable js for Field sorting {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://kit.fontawesome.com/dc0561ad10.js" crossorigin="anonymous"></script>
<style>
  .options-field { width: 100%; }
</style>
{% endblock %}

{% block content %}
<div class="card w-75 mx-auto mt-4">
  <h5 class="card-header">Employee Form Builder</h5>
  <div class="card-body">
    <form id="fields-form">
      {% for field in form.visible_fields %}
      <div class="form-group row mb-2">
        <label class="col-sm-4 col-form-label">{{ field.label_tag }}</label>
        <div class="col-sm-8">{% render_field field class='form-control' %}</div>
      </div>
      {% endfor %}

      <hr/>
      {% comment %} Dynamic Fields comes below {% endcomment %}
      <h6>Dynamic Fields</h6>
      <ul id="fields-list" style="list-style:none;padding-left:0">

        {% comment %} For initial saved fields {% endcomment %}
        {% for dyn_field in dynamic_fields %}
        <li data-id="{{ dyn_field.id }}" class="mb-2 border p-3">
          <div class="row g-2 align-items-center">
            <div class="col-md-4">
              <input class="form-control fld-label" value="{{ dyn_field.field_label }}" placeholder="Label" />
            </div>
            <div class="col-md-3">
              <select class="form-control fld-type">
                <option value="text" {% if dyn_field.field_type == 'text' %}selected{% endif %}>Text</option>
                <option value="number" {% if dyn_field.field_type == 'number' %}selected{% endif %}>Number</option>
                <option value="date" {% if dyn_field.field_type == 'date' %}selected{% endif %}>Date</option>
                <option value="password" {% if dyn_field.field_type == 'password' %}selected{% endif %}>Password</option>
                <option value="textarea" {% if dyn_field.field_type == 'textarea' %}selected{% endif %}>Textarea</option>
                <option value="select" {% if dyn_field.field_type == 'select' %}selected{% endif %}>Select</option>
                <option value="checkbox" {% if dyn_field.field_type == 'checkbox' %}selected{% endif %}>Checkbox</option>
                <option value="radio" {% if dyn_field.field_type == 'radio' %}selected{% endif %}>Radio</option>
              </select>
            </div>
            <div class="col-md-2">
              <div class="form-check">
                <input class="form-check-input fld-required" type="checkbox" {% if dyn_field.field_is_required %}checked{% endif %} />
                <label class="form-check-label">Required</label>
              </div>
            </div>
            <div class="col-md-3 text-end">
              <button type="button" class="btn btn-danger btn-sm fld-remove">Remove</button>
              <button type="button" class="btn btn-outline-secondary btn-sm fld-grab">
                <i class="fas fa-sort"></i>
              </button>
            </div>
          </div>
          <div class="mt-2">
            <input class="form-control fld-options" value="{{ dyn_field.options }}" placeholder="Options (comma separated)" {% if dyn_field.field_type not in 'select,radio' %}hidden{% endif %}/>
          </div>
        </li>
        {% endfor %}
      </ul>

      <div class="mt-3">
        <button id="add-field" type="button" class="btn btn-primary btn-sm">Add Field</button>
        <button id="save-template" type="button" class="btn btn-success btn-sm">Save Template</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const fieldsList = document.getElementById('fields-list');
    const sortable = new Sortable(fieldsList, { animation: 150, handle: '.fld-grab' });

    // Create a new field item <li>
    function makeLi(label = '', type = 'text', required = false, options = '', id = null) {
      const li = document.createElement('li');
      li.className = 'mb-2 border p-3';
      if (id) li.setAttribute('data-id', id);

      li.innerHTML = `
        <div class="row g-2 align-items-center">
          <div class="col-md-4"><input class="form-control fld-label" value="${label}" placeholder="Label" /></div>
          <div class="col-md-3">
            <select class="form-control fld-type">
              <option value="text">Text</option>
              <option value="number">Number</option>
              <option value="date">Date</option>
              <option value="password">Password</option>
              <option value="textarea">Textarea</option>
              <option value="select">Select</option>
              <option value="checkbox">Checkbox</option>
              <option value="radio">Radio</option>
            </select>
          </div>
          <div class="col-md-2">
            <div class="form-check">
              <input class="form-check-input fld-required" type="checkbox" ${required ? 'checked' : ''} />
              <label class="form-check-label">Required</label>
            </div>
          </div>
          <div class="col-md-3 text-end">
            <button type="button" class="btn btn-danger btn-sm fld-remove">Remove</button>
            <button type="button" class="btn btn-outline-secondary btn-sm fld-grab"><i class="fas fa-sort"></i></button>
          </div>
        </div>
        <div class="mt-2">
          <input class="form-control fld-options" value="${options || ''}" placeholder="Options (comma separated)" ${['select', 'radio'].includes(type) ? '' : 'hidden'} />
        </div>
      `;

      li.querySelector('.fld-type').value = type;
      li.querySelector('.fld-remove').addEventListener('click', () => li.remove());
      li.querySelector('.fld-type').addEventListener('change', e => toggleOptionsVisibility(li, e.target.value));

      return li;
    }

    // Toggle visibility of options input for a given li
    function toggleOptionsVisibility(li, value) {
      const opt = li.querySelector('.fld-options');
      if (!opt) return;
      if (value === 'select' || value === 'radio') {
        opt.hidden = false;
      } else {
        opt.hidden = true;
        opt.value = '';
      }
    }

    // Initialize visibility for existing dynamic fields
    fieldsList.querySelectorAll('li').forEach(li => {
      const select = li.querySelector('.fld-type');
      if (select) toggleOptionsVisibility(li, select.value);
      select.addEventListener('change', e => toggleOptionsVisibility(li, e.target.value));
    });

    // Add new field button event
    document.getElementById('add-field').addEventListener('click', () => {
      fieldsList.appendChild(makeLi());
    });

    // Mark fields for deletion
    fieldsList.addEventListener('click', function (e) {
      if (e.target.classList.contains('fld-remove')) {
        const li = e.target.closest('li');
        if (li) {
          li.setAttribute('deleted', '1');
          li.style.display = 'none';
        }
      }
    });

    // Save form template
    document.getElementById('save-template').addEventListener('click', async () => {
      const items = Array.from(fieldsList.children).map((li, idx) => {
        const id = li.getAttribute('data-id');
        const deleted = li.getAttribute('deleted');
        return {
          id: id ? parseInt(id) : null,
          deleted: deleted ? parseInt(deleted) : null,
          label: li.querySelector('.fld-label').value,
          field_type: li.querySelector('.fld-type').value,
          required: li.querySelector('.fld-required').checked,
          order: idx,
          options: li.querySelector('.fld-options').value || ''
        };
      });

      try {
        const resp = await fetch(window.location.href, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ fields: items })
        });

        const data = await resp.json();
        if (resp.ok) {
          alert(data.message || 'Saved');
          window.location.reload();
        } else {
          alert(data.message || 'Error saving');
        }
      } catch (e) {
        console.error(e);
        alert('Failed to save template');
      }
    });
  });
</script>
{% endblock %}